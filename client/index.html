<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Appetite  |  Stuff Your Palm</title>
    <link href="styles.css" rel="stylesheet" type="text/css">
</head>
<body onload="selectTab($('top_rated'))">
<div class="wrapper">
<div class="pg_head_wrapper">
    <div class="pg_hd"><img class="logo" src="images/logo.png" width="218" height="58">
        <div class="tag">A demonstration of Palm's open app ecosystem</div>
        <div class="search_wrapper">
            <div class="search_field">
                <input onkeypress="doSearch(this)" type="text" id="search" value="Search"
                       onfocus="searchFocus(this)" onblur="searchBlur(this)">
            </div>
        </div>
    </div>
</div>
<div class="navbar_wrapper">
    <div class="navbar">
        <div class="tab">
            <div class="tab_head">
                <h2 id="top_rated" onclick="selectTab(this)">Top Rated</h2>
            </div>
        </div>
        <div class="tab">
            <div class="tab_head">
                <h2 id="top_paid" onclick="selectTab(this)">Top Paid</h2>
            </div>
        </div>
        <div class="tab">
            <div class="tab_head">
                <h2 id="top_free" onclick="selectTab(this)">Top Free</h2>
            </div>
        </div>
        <div class="tab">
            <div class="tab_head">
                <h2 id="top_grossing" onclick="selectTab(this)">Top Grossing</h2>
            </div>
        </div>
        <div class="tab">
            <div class="tab_head">
                <h2 id="top_overall" onclick="selectTab(this)">Top Overall</h2>
            </div>
        </div>
        <div class="tab">
            <div class="tab_head">
                <h2 id="newest" onclick="selectTab(this)">Newest</h2>
            </div>
        </div>
        <div class="tab">
            <div class="tab_head">
                <h2 id="all" onclick="selectTab(this)">All</h2>
            </div>
        </div>
    </div>
</div>
<div class="pg_content">
    <div class="sort">
        <table border="0" cellspacing="0" cellpadding="0">
            <tr>
                <td><input type="checkbox" id="chk_catalog" onchange="loadApps()" checked="checked"></td>
                <td>Palm App Catalog</td>
                <td>&nbsp;</td>
                <td><input type="checkbox" id="chk_web" onchange="loadApps()" checked="checked"></td>
                <td>Web Distribution</td>
                <td>&nbsp;</td>
                <td><input type="checkbox" id="chk_beta" onchange="loadApps()" checked="checked"></td>
                <td>Beta</td>
            </tr>
        </table>
    </div>
    <div id="loading" style="display:block">
        Loading... getting app data from Palm
    </div>
    <div id="app_container_container">
        <div id="app_container">
        </div>
    </div>
    <div class="clearing">&nbsp;</div>
    <div id="popup" class="hidden">
        <form id="SMSForm" method="POST" action="/sms/post">
        </form>
    </div>
    <div id="dimmer" class="hidden"></div>
</div>
<div id="more"><img src="images/btn_showmore_lg3.png" onclick="showMoreApps()"></div>
<div class="pg_foot">Copyright and all that jazz.</div>
</div>

<script src="js/lib/prototype.js" type="text/javascript"></script>
<script src="js/data.all.js" type="text/javascript"></script>
<script src="js/client.js" type="text/javascript"></script>

<script type="text/javascript">
    // Now we got here the data is all loaded
    $('loading').hide();

    // current search entered by the user, if any; should always be a string
    var searchString = "";

    // string corresponding to the currently selected tab
    var selectedTab;

    // the DOM tab element that has been selected
    var selectedTabElement;

    // tracks which channels (e.g., web, catalog, beta) are being displayed;
    // listeners on the checkboxes in the HTML call a function which syncs
    // the checkbox value with the properties on this object
    var channels = { catalog: true, web: true, beta: true };

    // a "client object" that wraps the Appetite REST endpoints with JavaScript functions
    var appetite = new Appetite(data);

    // how many apps to show
    var appCount = 48;

    // a reference to the timer used to refresh search results after an input delay
    var searchTimer;

    // invoked by a listener on the search text box, this function will fire up a timer
    // to do a search after a delay. the delay is to avoid constantly refreshing the
    // app list as the user types
    function doSearch(searchElement) {
        // cancel any pending search requests
        // FIXME: is this the right way to cancel the timer?
        if (searchTimer) searchTimer.cancelled = true;

        // copy search string from input text into global state
        searchString = searchElement.value;

        // create a timer to refresh apps in 1.5 seconds; if the search results are
        // refreshed in advance of this, the timer will be cancelled and the ref cleared
        searchTimer = setTimeout(loadApps, 1500);
    }

    // invoked when the user clicks on one of the tab H2 elements
    function selectTab(h2) {
        // setting these classes causes the tab to appear selected on-screen
        h2.parentNode.parentNode.className = "tab selected";

        // if a previous tab has been selected, eliminate the "selected" class so it
        // no longer appears pressed
        if (selectedTabElement) selectedTabElement.parentNode.parentNode.className = "tab";

        // set global state regarding the currently selected tab
        selectedTabElement = h2;
        selectedTab = h2.id;

        // refresh the displayed apps to correspond to the new tab state
        loadApps();
    }

    // refreshes the displayed apps; relies on global state to determine which
    // apps should be displayed
    function loadApps() {
        // sync the channels object with the channels checkboxes
        channels.catalog = $("chk_catalog").checked;
        channels.web = $("chk_web").checked;
        channels.beta = $("chk_beta").checked;

        // Setup the parameters to query the apps
        var opts = {
            size: appCount
        };
        if (selectedTab && selectedTab != 'all') {
            opts.type = selectedTab;
        };
        
        // do a query if one is passed in
        if (searchString != "") {
            opts.query = searchString;
        }
        var apps = appetite.find(opts);

        // display the data
        displayApps(apps);
    }
    
    function showMoreApps() {
        appCount = appCount + 48;
        loadApps();
    }

    function displayApps(apps) {
        var appContainer = $("app_container");

        // yeah, i'm doing it as a string; you got a problem with that?
        var appsHTML = "";
        for (var i = 0; i < apps.length; i++) {
            var app = apps[i];

            //console.log(app);

            var appHTML =
                  '<div class="module">' +
                    '<div class="app-card">' +
                      '<div class="card front">' +
                        '<div class="module_crnr"><img src="images/crnr_' + getAppCorner(app) + '.png" width="35" height="35" /></div>' +
                        '<img class="screen" src="' + $lo(app).images[0] + '" width="106" height="158" />' +
                        '<div class="module_hd"><img class="icon" src="' + app.icons[1].url + '" width="32" height="32" /> ' + getAppPrice(app) +
                            '<div class="clearing">&nbsp;</div>' +
                        '</div>' +
                        '<h1>' + app.title + '</h1>' +
                        $lo(app).developer + '<br />' +
                        getAppCategory(app) + '<br />' +
                        '<div class="module_rating"><img src="images/' + getStarImage(app) + '.png" width="77" height="12" /><br />' +
                            app.total_comments + ' comments</div>' +
                        'v' + app.version + '  |  ' + getAppSize(app) + '<br />' +
                        getAppDownloads(app) + ' downloads' +
                        '<div class="module_foot"><img onclick="flipOver(this)" src="images/btn_moreinfo.png" alt="More Info" width="74" height="20" /><img onclick="installApp(\'' + app.packageid + '\')" src="images/btn_install.png" alt="Install" width="74" height="20" /></div>' +
                      '</div>\n' +
                      '<div class="card back back2"><img class="screen" src="' + $lo(app).images[0] + '" width="106" height="158" />' +
                        '<div class="description">' +
                          '<h1>' + app.title + '</h1>' +
                          app.description +
                        '</div>' +
                        '<div class="module_foot"><img onclick="flipBack(this)" src="images/btn_back.png" alt="More Info" width="74" height="20" /><img onclick="installApp(\'' + app.packageid + '\')" src="images/btn_install.png" alt="Install" width="74" height="20" /></div>' +
                      '</div>\n' +
                    '</div>\n' +
                  '</div>';
            appsHTML += appHTML;
        }

        appContainer.innerHTML = appsHTML;
    }

    function getAppCorner(app) {
        if (app.channel == "web") {
            return "web";
        } else if (app.channel == "beta") {
            return "beta";
        } else {
            return "cat";
        }
    }

    function flipOver(element) {
        element.parentNode.parentNode.parentNode.className += " rotate";
    }

    function flipBack(element) {
        var parent = element.parentNode.parentNode.parentNode;
        if (parent.className.indexOf("rotate") != -1) {
            parent.className = parent.className.replace(" rotate", "");
        }
    }

    function $lo(app) {
        return app.localizations[0];
    }

    function getAppCategory(app) {
        var category = ($lo(app).categories) ? $lo(app).categories[0] : "(no category)";
        category = category.replace("!", ", ");
        return category;
    }

    function getAppDownloads(app) {
        return commaFormat(app.total_downloads);
    }

    function getAppSize(app) {
        var bytes = app.installed_size;
        var ext = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
        var unitCount = 0;
        for(; bytes > 1024; unitCount++) { bytes = bytes / 1024 };
        // if you are in bytes or kb, then round to full integer, else round to 2 decimal places
        bytes = (unitCount > 1) ? twoDecimalPlaces(bytes) : Math.ceil(bytes);
            
        return twoDecimalPlaces(bytes) + ext[unitCount];
    }

    function getStarImage(app) {
        var rating = app.rating;
        if (rating < 0.3) {
            return "stars_0-5"; // we need a 0-0
        } else if (rating < 0.7) {
            return "stars_0-5";
        } else if (rating < 1.3) {
            return "stars_1-0";
        } else if (rating < 1.7) {
            return "stars_1-5";
        } else if (rating < 2.3) {
            return "stars_2-0";
        } else if (rating < 2.7) {
            return "stars_2-5";
        } else if (rating < 3.3) {
            return "stars_3-0";
        } else if (rating < 3.7) {
            return "stars_3-5";
        } else if (rating < 4.3) {
            return "stars_4-0";
        } else if (rating < 4.7) {
            return "stars_4-5";
        } else {
            return "stars_5-0";
        }
    }

    function twoDecimalPlaces(number) {
        return Math.round(number * 100) / 100;
    }

    function commaFormat(amount) {
        var re = /(-?\d+)(\d{3})/
        while (re.test(amount)) {
            amount = amount.replace(re, "$1,$2");
        }
        return amount;
    }

    function getAppPrice(app) {
        var price = $lo(app).price;
        if (price == 0) return "FREE";

        // yes, putting a dollar sign here is evil. does writing TODO in the comment make it better?
        price = "$" + price;

        // prices just look awkward if they don't have two places to the right of the decimal
        if (("" + price).charAt(price.length - 2) == ".") price += 0;

        return price;
    }

    function searchFocus(searchElement) {
        if (searchString == "") searchElement.value = "";

        searchElement.className = "userValue";
    }

    function searchBlur(searchElement) {
        searchString = searchElement.value; 

        if (searchElement.value == "") {
            searchElement.value = "Search";
            searchElement.className = "";
        }
    }

    function installApp(packageid) {
        loadSmsPopup(packageid);

        var size = getDimensions();

        var dimmer = $("dimmer");
        dimmer.className = "dimmer";
        dimmer.style.width = size.width + "px";
        dimmer.style.height = size.height + "px";

        var popupSize = { width: 480, height: 120 };

        var popup = $("popup");
        console.log(popup.className);
        popup.className = "shown-popup";
        popup.style.left = Math.round((size.width / 2) - (popupSize.width / 2)) + "px";
        popup.style.top = Math.round((size.visibleHeight / 2) - (popupSize.height / 2)) + "px";
        popup.style.width = popupSize.width + "px";
        popup.style.height = popupSize.height + "px";
    }

    function loadSmsPopup(packageid) {
        new Ajax.Request("/sms/getPopup", {
            method: "get",
            onSuccess: function(xhr) {
                //xhr.responseText.evalScripts();

                // kill the border
                var popupHtml = xhr.responseText.replace("border:1px solid #494949;", "");

                // add the packageid
                //popupHtml += '<input type="hidden" name="packageid" value="\'' + packageId '\'" />';

                $("SMSForm").innerHTML = popupHtml;
            }
        });
    }

    function getDimensions() {
        return {
            visibleHeight: self.innerHeight || document.documentElement.clientHeight || document.body.clientHeight,
            height: Math.max(Math.max(document.body.scrollHeight, document.documentElement.scrollHeight), Math.max(document.body.clientHeight, document.documentElement.clientHeight)),
            width: Math.max(Math.max(document.body.scrollWidth, document.documentElement.scrollWidth), Math.max(document.body.clientWidth, document.documentElement.clientWidth))
        }
    }

    function palm_sms_updateCountryPrefix()
    {
        var menu = document.getElementById('palm_sms_countryMenu');
        var value = menu.options[menu.selectedIndex].value;
        var cc = value.split(":");
        document.getElementById('palm_sms_callingPrefix').value = "+"+cc[0];
        document.getElementById('palm_sms_cc').value = cc[1];
    }

    function palm_sms_showCountryMenu()
    {
        document.getElementById('palm_sms_countryNameDiv').style.display = 'none';
        document.getElementById('palm_sms_countryMenuDiv').style.display = 'block';
        document.getElementById('palm_sms_callingPrefix').style.display = 'block';
        document.getElementById('palm_sms_phoneRow').setAttribute('class', 'palm_sms_withPrefix');
    }

    function palm_sms_verifySubmit()
    {
        var enteredPh = document.getElementById('palm_sms_phoneNum').value;
        var sanitized = enteredPh.replace(/[\(\)\-\s]/g, '');
        if (isNaN(parseFloat(sanitized)) || !isFinite(sanitized)) {
            document.getElementById('palm_sms_msgError').innerHTML = "Please enter a valid phone number for the selected country";
            document.getElementById('palm_sms_msgError').setAttribute('class', 'palm_sms_msgError');
        } else {
            document.getElementById('palm_sms_ph').value = sanitized;
            document.getElementById('palm_sms_msgError').setAttribute('class', 'palm_sms_hide');
            document.getElementById('SMSForm').submit();
        }
    }

</script>
</body>
</html>
